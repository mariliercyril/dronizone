{
	"info": {
		"_postman_id": "a9470404-7136-43f0-86fe-289e2060c50f",
		"name": "fourre-totu",
		"schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
	},
	"item": [
		{
			"name": "PUT collection ARRAY",
			"event": [
				{
					"listen": "prerequest",
					"script": {
						"id": "300f738e-0c51-4597-a8ea-aead2746d67e",
						"exec": [
							"function D () {",
							"    var randomD = {};",
							"    let enumBattery = [\"FULL\", \"OK\", \"LOW\"];",
							"    let enumStates = [\"AVAILABLE\", \"RECHARGING\", \"DELIVERING\", \"FORCED_RETURNING\"];",
							"    ",
							"    randomD.id = Math.floor(Math.random() * 2000);",
							"    randomD.batteryState = enumBattery[Math.floor(Math.random() * enumBattery.length)];",
							"    randomD.status = enumStates[Math.floor(Math.random() * enumStates.length)];",
							"    ",
							"    return randomD;",
							"}",
							"",
							"var arrD = [],",
							"    nbDrones = 15;",
							"",
							"// Ajouter 1 Drone AVAILABLE",
							"let avD = D();",
							"avD.status = \"AVAILABLE\";",
							"arrD.push(avD);",
							"",
							"// Générer nbDrones random D",
							"for (let i=0; i<nbDrones; ++i) {",
							"    arrD.push(D());",
							"}",
							"",
							"",
							"var collD = {};",
							"for (let d of arrD) {",
							"    collD[d.id] = d;",
							"}",
							"",
							"// stocker",
							"postman.setEnvironmentVariable(\"arrD\", JSON.stringify((arrD)));",
							"postman.setEnvironmentVariable(\"collD\", JSON.stringify((collD)));",
							"",
							""
						],
						"type": "text/javascript"
					}
				},
				{
					"listen": "test",
					"script": {
						"id": "9989966f-98e2-4d43-b818-d202c68686c0",
						"exec": [
							"let responseArrD = JSON.parse(responseBody),",
							"    arrD = JSON.parse(pm.environment.get(\"arrD\"));",
							"",
							"let idResponseArrD = responseArrD.reduce((obj, item) => {",
							"     obj[item.id] = \"osef\" // je mets pas l'objet entier car le Service complète les attributs des Drones que je n'ai pas mis (genre position etc...)",
							"     return obj",
							"   }, {}),",
							"   ",
							"   idArrD = arrD.reduce((obj, item) => {",
							"     obj[item.id] = \"osef\" // je mets pas l'objet entier car le Service complète les attributs des Drones que je n'ai pas mis (genre position etc...)",
							"     return obj",
							"   }, {});",
							"",
							"console.log(\"idResponseArrD\", idResponseArrD);",
							"console.log(\"idArrD\", idArrD);",
							"",
							"// Check que les mêmes clefs sont présentes des deux côtés",
							"pm.expect(idArrD).to.eql(idResponseArrD);"
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "PUT",
				"header": [
					{
						"key": "Content-Type",
						"name": "Content-Type",
						"value": "application/json",
						"type": "text"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{{arrD}}",
					"options": {
						"raw": {
							"language": "json"
						}
					}
				},
				"url": {
					"raw": "localhost:9004/fleet/drones",
					"host": [
						"localhost"
					],
					"port": "9004",
					"path": [
						"fleet",
						"drones"
					]
				}
			},
			"response": []
		},
		{
			"name": "GET all",
			"request": {
				"method": "GET",
				"header": [],
				"url": {
					"raw": "localhost:9004/fleet/drones",
					"host": [
						"localhost"
					],
					"port": "9004",
					"path": [
						"fleet",
						"drones"
					]
				}
			},
			"response": []
		},
		{
			"name": "POST newD",
			"event": [
				{
					"listen": "prerequest",
					"script": {
						"id": "425b6821-6729-4007-9165-334142f0a47e",
						"exec": [
							"function D () {",
							"    var randomD = {};",
							"    let enumBattery = [\"FULL\", \"OK\", \"LOW\"];",
							"    let enumStates = [\"AVAILABLE\", \"RECHARGING\", \"DELIVERING\", \"FORCED_RETURNING\"];",
							"    ",
							"    randomD.id = parseInt(new Date().getSeconds() + \"\" + new Date().getMilliseconds());",
							"    randomD.batteryState = enumBattery[Math.floor(Math.random() * enumBattery.length)];",
							"    randomD.status = enumStates[Math.floor(Math.random() * enumStates.length)];",
							"    randomD.assignedOrderId = \"potata\"",
							"    ",
							"    return randomD;",
							"}",
							"",
							"// Save globally",
							"postman.setEnvironmentVariable(\"D\", D);",
							"",
							"// let myD = D();",
							"var parsedFunc = eval(\"(\" + environment.D +\")\");",
							"var myD = parsedFunc();",
							" ",
							"postman.setEnvironmentVariable(\"randomD\", JSON.stringify((myD)));"
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "POST",
				"header": [
					{
						"key": "Content-Type",
						"name": "Content-Type",
						"value": "application/json",
						"type": "text"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{{randomD}}",
					"options": {
						"raw": {
							"language": "json"
						}
					}
				},
				"url": {
					"raw": "localhost:9004/fleet/drones",
					"host": [
						"localhost"
					],
					"port": "9004",
					"path": [
						"fleet",
						"drones"
					]
				}
			},
			"response": []
		},
		{
			"name": "[debug] marco polo",
			"event": [
				{
					"listen": "prerequest",
					"script": {
						"id": "a05cd7dd-7a7e-4c78-b71f-86425965939f",
						"exec": [
							"function D () {",
							"    var randomD = {};",
							"    let enumBattery = [\"FULL\", \"OK\", \"LOW\"];",
							"    let enumStates = [\"AVAILABLE\", \"RECHARGING\", \"DELIVERING\", \"RETURNING\"];",
							"    ",
							"    randomD.id = Math.floor(Math.random() * 2000);",
							"    randomD.batteryState = enumBattery[Math.floor(Math.random() * enumBattery.length)];",
							"    randomD.status = enumStates[Math.floor(Math.random() * enumStates.length)];",
							"    ",
							"    return randomD;",
							"}",
							"",
							"/*",
							"function randomId() {",
							"    return parseInt(new Date().getSeconds() + \"\" + new Date().getMilliseconds()); // le script gen tout dans la même MS...",
							"}",
							"function randomBattery() {",
							"    let enumBattery = [\"FULL\", \"OK\", \"LOW\"];",
							"    return enumBattery[Math.floor(Math.random() * enumBattery.length)];",
							"}",
							"function randomState() {",
							"    let enumStates = [\"AVAILABLE\", \"RECHARGING\", \"DELIVERING\", \"RETURNING\"];",
							"    return enumStates[Math.floor(Math.random() * enumStates.length)];",
							"} //*/",
							"",
							"",
							"",
							"var arrD = [];",
							"",
							"// générer 5 random D",
							"for (let i=0, l=5; i<5; ++i) {",
							"    arrD.push(D());",
							"}",
							"",
							"var collD = {};",
							"for (let d of arrD) {",
							"    collD[d.id] = d;",
							"}",
							"",
							"// stocker",
							"postman.setEnvironmentVariable(\"arrD\", JSON.stringify((arrD)));",
							"postman.setEnvironmentVariable(\"collD\", JSON.stringify((collD)));",
							"",
							""
						],
						"type": "text/javascript"
					}
				}
			],
			"protocolProfileBehavior": {
				"disableBodyPruning": true
			},
			"request": {
				"method": "GET",
				"header": [
					{
						"key": "Content-Type",
						"name": "Content-Type",
						"type": "text",
						"value": "application/json"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "[\n\t{{arrD}},\n\t{{collD}}\n]",
					"options": {
						"raw": {
							"language": "json"
						}
					}
				},
				"url": {
					"raw": "localhost:9004/fleet/marco",
					"host": [
						"localhost"
					],
					"port": "9004",
					"path": [
						"fleet",
						"marco"
					]
				},
				"description": "Echo l'objet reçu"
			},
			"response": []
		},
		{
			"name": "[fail] PUT collection COLLECTION",
			"event": [
				{
					"listen": "prerequest",
					"script": {
						"id": "e3ea632e-6ad3-4b4a-a6db-5cbdedf6f286",
						"exec": [
							"function D () {",
							"    var randomD = {};",
							"    let enumBattery = [\"FULL\", \"OK\", \"LOW\"];",
							"    let enumStates = [\"AVAILABLE\", \"RECHARGING\", \"DELIVERING\", \"FORCED_RETURNING\"];",
							"    ",
							"    randomD.id = Math.floor(Math.random() * 2000);",
							"    randomD.batteryState = enumBattery[Math.floor(Math.random() * enumBattery.length)];",
							"    randomD.status = enumStates[Math.floor(Math.random() * enumStates.length)];",
							"    ",
							"    return randomD;",
							"}",
							"",
							"/*",
							"function randomId() {",
							"    return parseInt(new Date().getSeconds() + \"\" + new Date().getMilliseconds()); // le script gen tout dans la même MS...",
							"}",
							"function randomBattery() {",
							"    let enumBattery = [\"FULL\", \"OK\", \"LOW\"];",
							"    return enumBattery[Math.floor(Math.random() * enumBattery.length)];",
							"}",
							"function randomState() {",
							"    let enumStates = [\"AVAILABLE\", \"RECHARGING\", \"DELIVERING\", \"RETURNING\"];",
							"    return enumStates[Math.floor(Math.random() * enumStates.length)];",
							"} //*/",
							"",
							"",
							"",
							"var arrD = [];",
							"",
							"// générer 5 random D",
							"for (let i=0, l=5; i<5; ++i) {",
							"    arrD.push(D());",
							"}",
							"",
							"var collD = {};",
							"for (let d of arrD) {",
							"    collD[d.id] = d;",
							"}",
							"",
							"// stocker",
							"postman.setEnvironmentVariable(\"arrD\", JSON.stringify((arrD)));",
							"postman.setEnvironmentVariable(\"collD\", JSON.stringify((collD)));",
							"",
							""
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "PUT",
				"header": [
					{
						"key": "Content-Type",
						"name": "Content-Type",
						"value": "application/json",
						"type": "text"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{{collD}}",
					"options": {
						"raw": {
							"language": "json"
						}
					}
				},
				"url": {
					"raw": "localhost:9004/fleet/drones",
					"host": [
						"localhost"
					],
					"port": "9004",
					"path": [
						"fleet",
						"drones"
					]
				}
			},
			"response": []
		},
		{
			"name": "GET all telemetry by D's ID",
			"request": {
				"method": "GET",
				"header": [],
				"url": {
					"raw": "localhost:9004/fleet/drones/69/positions",
					"host": [
						"localhost"
					],
					"port": "9004",
					"path": [
						"fleet",
						"drones",
						"69",
						"positions"
					]
				}
			},
			"response": []
		},
		{
			"name": "POST custom D",
			"request": {
				"method": "POST",
				"header": [
					{
						"key": "Content-Type",
						"name": "Content-Type",
						"value": "application/json",
						"type": "text"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\r\n\t\"id\": 69,\r\n    \"batteryState\": \"LOW\",\r\n    \"status\": \"RECHARGING\"\r\n}",
					"options": {
						"raw": {
							"language": "json"
						}
					}
				},
				"url": {
					"raw": "localhost:9004/fleet/drones",
					"host": [
						"localhost"
					],
					"port": "9004",
					"path": [
						"fleet",
						"drones"
					]
				}
			},
			"response": []
		},
		{
			"name": "POST randomPos",
			"event": [
				{
					"listen": "prerequest",
					"script": {
						"id": "8c76c9fd-94f1-4bbf-b9d0-c3955df01b90",
						"exec": [
							"let pos = {};",
							"",
							"function getRandomInt(max) {",
							"  return Math.floor(Math.random() * Math.floor(max));",
							"}",
							"",
							"function random() {",
							"    pos.timestamp = new Date().getTime();",
							"    pos.latitude = getRandomInt(180) - 90; // de -90 à 90",
							"    pos.longitude = getRandomInt(360) - 180; // de -180 à 180",
							"}",
							"",
							"postman.setEnvironmentVariable(\"posD\", JSON.stringify(pos));"
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "POST",
				"header": [
					{
						"key": "Content-Type",
						"name": "Content-Type",
						"value": "application/json",
						"type": "text"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{{posD}}",
					"options": {
						"raw": {
							"language": "json"
						}
					}
				},
				"url": {
					"raw": "localhost:9004/fleet/drones/69/positions",
					"host": [
						"localhost"
					],
					"port": "9004",
					"path": [
						"fleet",
						"drones",
						"69",
						"positions"
					]
				}
			},
			"response": []
		},
		{
			"name": "Rappeler tous les Drones",
			"request": {
				"method": "GET",
				"header": [],
				"url": {
					"raw": "localhost:9004/fleet/drones/totalrecall",
					"host": [
						"localhost"
					],
					"port": "9004",
					"path": [
						"fleet",
						"drones",
						"totalrecall"
					]
				}
			},
			"response": []
		},
		{
			"name": "GET all telemetry by D's ID after 6s",
			"event": [
				{
					"listen": "prerequest",
					"script": {
						"id": "094029e1-99bf-4a43-a459-dfad72343912",
						"exec": [
							"let assignedDroneId = pm.globals.get(\"variable_key\");\r",
							"\r",
							"// dans le code, un livraison dure 5s, on attend 6\r",
							"setTimeout(function(){}, 6000);\r",
							""
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "GET",
				"header": [],
				"url": {
					"raw": "localhost:9004/fleet/drones/{{assignedDroneId}}/positions",
					"host": [
						"localhost"
					],
					"port": "9004",
					"path": [
						"fleet",
						"drones",
						"{{assignedDroneId}}",
						"positions"
					]
				}
			},
			"response": []
		},
		{
			"name": "RESET (vider BD Drones + télémétrie",
			"request": {
				"method": "GET",
				"header": [],
				"url": {
					"raw": "localhost:9004/fleet/drones/reset",
					"host": [
						"localhost"
					],
					"port": "9004",
					"path": [
						"fleet",
						"drones",
						"reset"
					]
				}
			},
			"response": []
		},
		{
			"name": "Assign random order ID",
			"event": [
				{
					"listen": "prerequest",
					"script": {
						"id": "d86d3489-b868-4c28-8be4-8dd62d7bf6fe",
						"exec": [
							"function makeid(length) {\r",
							"   var result           = '';\r",
							"   var characters       = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';\r",
							"   var charactersLength = characters.length;\r",
							"   for ( var i = 0; i < length; i++ ) {\r",
							"      result += characters.charAt(Math.floor(Math.random() * charactersLength));\r",
							"   }\r",
							"   return result;\r",
							"}\r",
							"\r",
							"let orderid = makeid(8);\r",
							"\r",
							"postman.setEnvironmentVariable(\"orderid\", JSON.stringify(orderid));\r",
							""
						],
						"type": "text/javascript"
					}
				},
				{
					"listen": "test",
					"script": {
						"id": "9013b841-9bd1-463d-82ce-11773c5c5b08",
						"exec": [
							"var jsonData = JSON.parse(responseBody);",
							"let assignedDroneId = jsonData[\"id\"];",
							"",
							"console.log(\"jsonData\", jsonData);",
							"console.log(\"assignedDroneId\", assignedDroneId);",
							"",
							"pm.globals.set(\"assignedDroneId\", assignedDroneId);"
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "POST",
				"header": [],
				"url": {
					"raw": "localhost:9004/fleet/assign?orderid={{$randomWords}}",
					"host": [
						"localhost"
					],
					"port": "9004",
					"path": [
						"fleet",
						"assign"
					],
					"query": [
						{
							"key": "orderid",
							"value": "{{$randomWords}}"
						}
					]
				},
				"description": "localhost:9004/fleet/assign?orderid={{$randomWords}}"
			},
			"response": []
		}
	],
	"protocolProfileBehavior": {}
}